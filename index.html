<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Quantum Reality AR</title>
    
    <!-- A-Frame Core -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    
    <!-- AR.js for Cross-Browser AR -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    
    <!-- Game Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    
    <style>
        /* ... (keep your existing styles) ... */
        
        /* Camera Feed Fix */
        .a-enter-ar .a-canvas {
            position: static !important;
        }
        
        /* Desktop Overlay */
        #desktop-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            color: white;
            text-align: center;
            padding-top: 20%;
        }
        
        #desktop-overlay button {
            padding: 15px 30px;
            font-size: 18px;
            background: #ff00ff;
            color: white;
            border: none;
            border-radius: 30px;
            margin: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- AR Permission Screen -->
    <div id="ar-permission">
        <h2>QUANTUM REALITY</h2>
        <p>Point your camera at a flat surface to start</p>
        <button id="start-ar">ACTIVATE AR</button>
        <p id="support-warning"></p>
        <p><small>Requires Chrome/Edge on Android or Safari on iOS</small></p>
    </div>

    <!-- Desktop Overlay -->
    <div id="desktop-overlay">
        <h2>DESKTOP MODE ACTIVATED</h2>
        <p>Use mouse and keyboard to explore quantum reality</p>
        <button id="start-desktop">START DESKTOP EXPERIENCE</button>
        <p><small>For best experience, use mobile device with camera</small></p>
    </div>

    <!-- AR Scene -->
    <a-scene 
        vr-mode-ui="enabled: false"
        renderer="colorManagement: true; precision: mediump;"
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        id="ar-scene"
    >
        <!-- Camera -->
        <a-camera 
            id="ar-cam" 
            gps-camera 
            rotation-reader
        ></a-camera>
        
        <!-- Dynamic Content -->
        <a-entity id="dynamic-content"></a-entity>
        
        <!-- Loading Indicator -->
        <a-entity position="0 0 -1">
            <a-text 
                id="loading-text"
                value="Calibrating quantum field..."
                align="center"
                color="#FF00FF"
                position="0 0.2 0"
            ></a-text>
        </a-entity>
    </a-scene>

    <!-- Game HUD -->
    <div id="hud" class="hidden">
        <div>ROLE: <span id="role-display">DREAMER</span></div>
        <div>QUANTUM DEBT: <span id="debt-display">100%</span></div>
        <div>PROPHECY: <span id="prophecy-display">Create water where shadows sleep</span></div>
    </div>

    <!-- Main Game Script -->
    <script type="module" src="app.js"></script>
    
    <!-- Camera Fix Script -->
    <script>
        // Global camera stream reference
        let cameraStream = null;

        // Camera restart function
        window.restartCamera = async function() {
            try {
                // Stop existing stream
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }
                
                // Get new camera stream
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                // Apply to AR.js
                const scene = document.querySelector('a-scene');
                scene.setAttribute('arjs', 'sourceType: webcam; sourceWidth: 1280; sourceHeight: 720;');
                
                // Hide warning
                document.getElementById('support-warning').textContent = "";
                
            } catch (error) {
                console.error("Camera restart failed:", error);
                document.getElementById('support-warning').innerHTML = `
                    Camera Error: ${error.name}<br>
                    <button onclick="restartCamera()">Retry Camera</button>
                    <button onclick="document.getElementById('desktop-overlay').style.display='block'">
                        Switch to Desktop Mode
                    </button>
                `;
            }
        };
    </script>
</body>
</html>